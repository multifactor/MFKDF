<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<title>Multi-Factor Key Derivation Function (MFKDF)</title>
		<meta name="description" content="Multi-Factor Key Derivation Function (MFKDF)">
		<link rel="icon" href="favicon.ico">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/atom-one-dark.min.css">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="site.css">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#fc4400">
    <meta name="msapplication-TileColor" content="#fc4400">
    <meta name="theme-color" content="#fc4400">
	</head>
	<body>
		<header>
			<div class="container">
				<a href="index.html"><img src="logo.png" height="80"></a>
				<a href="demo.html" class="btn btn-primary btn-lg active">Demo</a>
				<a href="docs/index.html" class="btn btn-primary btn-lg">Documentation</a>
			</div>
		</header>
		<div class="container main text-center">
			<section>
				<h2 class="mt-0">HOTP MFKDF Demo</h2>
				<p>This page is a basic demonstration of an HOTP-based key derivation.</p>
        <form id="form">
          <img id="qr" height="200" width="200" /><br>
          <div class="form-group">
            <label for="sq">HOTP Code (Counter: <span id="ctr">1</span>)</label>
            <input type="text" class="form-control" id="setup" placeholder="Enter HOTP Code">
          </div>
          <button type="submit" class="btn btn-primary btn-block">Verify</button>
        </form>
			</section>
		</div>
		<script src="image.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mfkdf@0.5.0/mfkdf.min.js" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js" integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/otpauth/dist/otpauth.umd.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
			const hotp = new OTPAuth.HOTP({
				issuer: 'MFKDF',
				label: 'HOTPDemo',
				algorithm: 'SHA1',
				digits: 6,
				counter: 0,
				secret: 'NB2W45DFOIZA'
			});

			const uri = OTPAuth.URI.stringify(hotp);
			$("#qr").attr('src', 'https://www.google.com/chart?chs=200x200&chld=M|0&cht=qr&chl=' + encodeURIComponent(uri));

			var target = 999999;
			var counter = 1;
			var expected = hotp.generate({counter: 1});
			var offset = target - expected;

			$("#form").submit((e) => {
				e.preventDefault();

				(async () => {
					console.log('asd');
					const setup = $("#setup").val();
					const key = await mfkdf.factors.hotp(parseInt(setup), offset);
					if (key.toString('hex') !== '045425a7d173b00ee53d8adba85c966489faba108a7e86b222f9719650b4965e') {
						alert('Invalid HOTP code')
					} else {
						alert('Key successfully generated! 045425a7d173b00ee53d8adba85c966489faba108a7e86b222f9719650b4965e');
						$("#setup").val('');
						counter++;
						$("#ctr").text(counter);
						expected = hotp.generate({counter: counter});
						offset = target - expected;
					}
				})()
			})

      // console.log(mfkdf);
			// $("#form").submit((e) => {
			// 	e.preventDefault();
			// 	const password = $("#password").val();
			// 	const rc = $("#rc").val();
			// 	const sq = $("#sq").val();
			// 	const factors = {};
			//
			// 	(async () => {
			// 		// Derive Key Using Provided Factors
			// 		if (password.length) factors.password = await mfkdf.factors.password(password)
			// 		if (rc.length) factors.rc = await mfkdf.factors.recoveryCode(rc)
			// 		if (sq.length) factors.sq = await mfkdf.factors.questions({'first-pet': sq})
			// 		const derivedKey = await mfkdf.derive(
			// 			factors, JSON.parse('{"t":2,"s":"f3cb18392516022acd3a035d82fa83b481e9285b99ee8e19964f0c4bd4123fff","p":{"password":"26b93510fd61906a8d88707688a7f5d41f77df2da7aea06449d35ec87b5c9f4f739c05df87f57878f07b5ba4efd15fe8","sq":"838bdae459a700e211807be1d0ec38d8f18b7984c333f55214bfa663330a86988cb42759d84cfb0c2e7a6985aef88a67","rc":"8543605a7a0a7eaf925f0852adee9ad40d9d72e59aa30557f9fbd372a8cfdd91ba0c1a5d64728fe521770e8230a52c2d"}}') // config generated by mfkdf.setup()
			// 		); // 8564d0316e93468efc3aee181a5be8c718b481ce66bb9e7b50ac035e11c2a3ad
			//
			// 		// Use Key To Decrypt & Display Image
			// 		const image = CryptoJS.AES.decrypt(encrypted, derivedKey.toString('hex')).toString(CryptoJS.enc.Utf8);
			// 		if (image.startsWith('data:image/jpeg;base64,')) { // decryption succeeded
			// 			$("#image").attr('src', image);
			// 			$("#form").slideUp();
			// 			$("#success").slideDown();
			// 		} else {
			// 			throw new Error('Decryption failed - one or more factors must have been incorrect!');
			// 		}
			// 	})()
			// 	.catch((err) => {
			// 		alert(err);
			// 	})
			// })
    </script>
	</body>
</html>
